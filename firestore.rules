rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== FONCTIONS HELPER ====================
    
    // Vérifier si l'utilisateur est authentifié
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Vérifier si l'utilisateur est le propriétaire du document
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Récupérer le document utilisateur
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Vérifier le rôle de l'utilisateur
    function hasRole(role) {
      return isSignedIn() && getUserData().role == role;
    }
    
    // Vérifier si l'utilisateur est admin
    function isAdmin() {
      return hasRole('admin');
    }
    
    // Vérifier si l'utilisateur est professeur
    function isProf() {
      return hasRole('prof');
    }
    
    // Vérifier si l'utilisateur est élève
    function isEleve() {
      return hasRole('eleve');
    }
    
    // Vérifier si l'utilisateur est parent
    function isParent() {
      return hasRole('parent');
    }
    
    // Vérifier si l'utilisateur a un abonnement Premium actif
    function isPremium() {
      return isSignedIn() && 
             getUserData().isPremium == true &&
             getUserData().subscriptionEnd > request.time;
    }
    
    // ==================== COLLECTION: users ====================
    
    match /users/{userId} {
      // Lecture: 
      // - Utilisateur peut lire son propre profil
      // - Admin peut tout lire
      // - Parent peut lire les profils (pour rechercher un enfant par codeParent)
      allow read: if isOwner(userId) || isAdmin() || isParent() || isProf();
      
      // Création: uniquement lors de l'inscription (via Authentication)
      allow create: if isSignedIn() && 
                       request.auth.uid == userId &&
                       request.resource.data.keys().hasAll(['email', 'role', 'isPremium']);
      
      // Mise à jour: utilisateur peut modifier son profil, admin peut tout modifier
      allow update: if isOwner(userId) || isAdmin();
      
      // Suppression: uniquement admin
      allow delete: if isAdmin();
    }
    
    // ==================== COLLECTION: niveaux ====================
    
    match /niveaux/{niveauId} {
      // Lecture: tout le monde peut lire
      allow read: if true;
      
      // Écriture: uniquement admin
      allow write: if isAdmin();
    }
    
    // ==================== COLLECTION: classes ====================
    
    match /classes/{classeId} {
      // Lecture: tout le monde peut lire
      allow read: if true;
      
      // Écriture: uniquement admin
      allow write: if isAdmin();
    }
    
    // ==================== COLLECTION: matieres ====================
    
    match /matieres/{matiereId} {
      // Lecture: tout le monde peut lire
      allow read: if true;
      
      // Écriture: uniquement admin et professeurs
      allow create: if isAdmin() || isProf();
      allow update: if isAdmin() || isProf();
      allow delete: if isAdmin();
    }

    // ==================== COLLECTION: disciplines ====================

    match /disciplines/{disciplineId} {
      // Lecture: tout le monde peut lire les disciplines
      allow read: if true;

      // Écriture: uniquement admin et professeurs
      allow create: if isAdmin() || isProf();
      allow update: if isAdmin() || isProf();
      allow delete: if isAdmin();
    }

    // ==================== COLLECTION: chapitres ====================

    match /chapitres/{chapitreId} {
      // Lecture: tout le monde peut lire les chapitres
      allow read: if true;

      // Écriture: uniquement admin et professeurs
      allow create: if isAdmin() || isProf();
      allow update: if isAdmin() || isProf();
      allow delete: if isAdmin();
    }
    
    // ==================== COLLECTION: ressources ====================
    
       match /ressources/{ressourceId} {
      // Lecture: tout utilisateur authentifié peut lire
      // (le filtrage Premium se fait côté UI dans ResourceView.tsx)
      allow read: if isSignedIn();
      
      // Création: admin et professeurs
      allow create: if isAdmin() || isProf();
      
      // Mise à jour: admin et professeur créateur
      allow update: if isAdmin() || 
                       (isProf() && resource.data.auteurId == request.auth.uid);
      
      // Suppression: admin et professeur créateur
      allow delete: if isAdmin() || 
                       (isProf() && resource.data.auteurId == request.auth.uid);
    }
    
    // ==================== COLLECTION: quizzes ====================
    
    match /quizzes/{quizId} {
      // Lecture: 
      // - Quiz gratuits: tout le monde
      // - Quiz premium: uniquement utilisateurs premium
      allow read: if !resource.data.isPremium || isPremium() || isAdmin() || isProf();
      
      // Création: admin et professeurs
      allow create: if isAdmin() || isProf();
      
      // Mise à jour: admin uniquement
      allow update: if isAdmin();
      
      // Suppression: admin uniquement
      allow delete: if isAdmin();
    }
   match /quizzes_v2/{quizId} {
       allow read: if !resource.data.isPremium || isPremium() || isAdmin() || isProf();
       allow create: if isAdmin() || isProf();
       allow update: if isAdmin();
       allow delete: if isAdmin();
}
    
    // ==================== COLLECTION: quiz_results ====================
    
    match /quiz_results/{resultId} {
      // Lecture: 
      // - Utilisateur peut voir ses propres résultats
      // - Admin et profs peuvent tout voir
      // - Parent peut voir les résultats (vérifié côté service via lien actif)
      allow read: if isOwner(resource.data.userId) || isAdmin() || isProf() || isParent();
      
      // Création: uniquement l'utilisateur qui passe le quiz
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Mise à jour et suppression: uniquement admin
      allow update, delete: if isAdmin();
    }
    
    // ==================== COLLECTION: seances ====================
    
    match /seances/{seanceId} {
      // Lecture: élèves de la classe concernée, professeurs, admin
      allow read: if isSignedIn();
      
      // Création: professeurs et admin
      allow create: if isProf() || isAdmin();
      
      // Mise à jour: professeur créateur et admin
      allow update: if isAdmin() || 
                       (isProf() && resource.data.professeurId == request.auth.uid);
      
      // Suppression: professeur créateur et admin
      allow delete: if isAdmin() || 
                       (isProf() && resource.data.professeurId == request.auth.uid);
    }
    
    // ==================== COLLECTION: transactions ====================
    
    match /transactions/{transactionId} {
      // Lecture: utilisateur peut voir ses propres transactions, admin peut tout voir
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Création: utilisateur peut créer ses propres transactions
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Mise à jour: uniquement système (via Cloud Functions) et admin
      allow update: if isAdmin();
      
      // Suppression: uniquement admin
      allow delete: if isAdmin();
    }
    
    // ==================== COLLECTION: student_stats ====================
    
    match /student_stats/{userId} {
      // Lecture: utilisateur peut voir ses propres stats, admin et profs peuvent tout voir
      allow read: if isOwner(userId) || isAdmin() || isProf();
      
      // Écriture: uniquement système (via Cloud Functions) et admin
      allow write: if isAdmin();
    }
    
    // ==================== COLLECTION: prof_stats ====================
    
    match /prof_stats/{userId} {
      // Lecture: professeur peut voir ses propres stats, admin peut tout voir
      allow read: if isOwner(userId) || isAdmin();
      
      // Écriture: uniquement système (via Cloud Functions) et admin
      allow write: if isAdmin();
    }
    
    // ==================== COLLECTION: liens_parent_enfant (Phase 10) ====================
    
    match /liens_parent_enfant/{lienId} {
      // Lecture:
      // - Parent propriétaire du lien
      // - Enfant concerné par le lien
      // - Admin
      allow read: if isSignedIn() && (
                       resource.data.parentId == request.auth.uid ||
                       resource.data.enfantId == request.auth.uid ||
                       isAdmin()
                     );
      
      // Création: parent authentifié uniquement
      allow create: if isSignedIn() && 
                       isParent() &&
                       request.resource.data.parentId == request.auth.uid;
      
      // Mise à jour: parent propriétaire (pour révoquer/suspendre) ou admin
      allow update: if isSignedIn() && (
                       (resource.data.parentId == request.auth.uid) ||
                       isAdmin()
                     );
      
      // Suppression: uniquement admin
      allow delete: if isAdmin();
    }
    
    // ==================== COLLECTION: alertes_parent (Phase 10) ====================
    
    match /alertes_parent/{alerteId} {
      // Lecture: parent destinataire ou admin
      allow read: if isSignedIn() && (
                       resource.data.parentId == request.auth.uid ||
                       isAdmin()
                     );
      
      // Création: parent authentifié (les alertes sont générées côté client)
      allow create: if isSignedIn() && 
                       isParent() &&
                       request.resource.data.parentId == request.auth.uid;
      
      // Mise à jour: parent (pour marquer comme lue) ou admin
      allow update: if isSignedIn() && (
                       (resource.data.parentId == request.auth.uid) ||
                       isAdmin()
                     );
      
      // Suppression: uniquement admin
      allow delete: if isAdmin();
    }

    // ============================================================
    // COLLECTION: groupes_prof (Phase 11 — Dashboard Professeurs)
    // ============================================================
    // Stocke les groupes-classes créés par les professeurs.
    // Chaque groupe a un code d'invitation unique PROF-XXXX-XXXX.
    // Seul le professeur créateur peut modifier/supprimer son groupe.
    // Les élèves peuvent lire les groupes (pour rejoindre via code).

    match /groupes_prof/{groupeId} {
      // Lecture:
      // - Professeurs authentifiés (pour gérer leurs groupes)
      // - Élèves authentifiés (pour chercher un groupe par code d'invitation)
      // - Admin (supervision globale)
      allow read: if isSignedIn() && (isProf() || isEleve() || isAdmin());

      // Création: uniquement professeurs et admin
      // Le profId dans le document DOIT correspondre à l'utilisateur connecté
      allow create: if isSignedIn() && (
                       (isProf() && request.resource.data.profId == request.auth.uid) ||
                       isAdmin()
                     );

      // Mise à jour:
      // - Le professeur créateur du groupe (profId == uid)
      // - L'élève peut incrémenter nombreInscrits lors de l'inscription
      // - Admin peut tout modifier
      allow update: if isSignedIn() && (
                       (isProf() && resource.data.profId == request.auth.uid) ||
                       isEleve() ||
                       isAdmin()
                     );

      // Suppression: uniquement le professeur créateur ou admin
      allow delete: if isSignedIn() && (
                       (isProf() && resource.data.profId == request.auth.uid) ||
                       isAdmin()
                     );
    }

    // ============================================================
    // COLLECTION: inscriptions_groupe (Phase 11 — Inscriptions élèves)
    // ============================================================
    // Stocke les inscriptions des élèves aux groupes-classes.
    // Un élève peut s'inscrire lui-même via un code d'invitation.
    // Le professeur du groupe peut voir et gérer les inscriptions.

    match /inscriptions_groupe/{inscriptionId} {
      // Lecture:
      // - Le professeur (via requête where groupeId pour ses groupes)
      // - L'élève inscrit (peut voir ses propres inscriptions)
      // - Admin (supervision globale)
      allow read: if isSignedIn() && (isProf() || isEleve() || isAdmin());

      // Création: uniquement l'élève qui s'inscrit
      // Le eleveId DOIT correspondre à l'utilisateur connecté
      allow create: if isSignedIn() && (
                       (isEleve() && request.resource.data.eleveId == request.auth.uid) ||
                       isAdmin()
                     );

      // Mise à jour:
      // - Le professeur du groupe (pour retirer un élève, changer statut)
      // - Admin
      allow update: if isSignedIn() && (isProf() || isAdmin());

      // Suppression: uniquement admin
      allow delete: if isAdmin();
    }
      // ==================== COLLECTION: progressions (Phase 14) ====================
    
    match /progressions/{progressionId} {
      // Lecture: l'élève voit ses propres progressions, admin/prof peuvent tout voir
      allow read: if isSignedIn() && (
                       resource.data.userId == request.auth.uid ||
                       isAdmin() || isProf() || isParent()
                     );
      
      // Création: l'élève crée sa propre progression
      allow create: if isSignedIn() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Mise à jour: l'élève met à jour sa propre progression
      allow update: if isSignedIn() && 
                       resource.data.userId == request.auth.uid;
      
      // Suppression: uniquement admin
      allow delete: if isAdmin();
    }    
	
     // ==================== PHASE 21 — CAHIER DE TEXTES ====================

match /cahiers_textes/{cahierId} {
  allow read: if request.auth != null && (
    resource.data.profId == request.auth.uid || isAdmin()
  );
  allow create: if request.auth != null
    && request.resource.data.profId == request.auth.uid
    && getUserData().role == 'prof'
    && getUserData().isPremium == true;
  allow update, delete: if request.auth != null && (
    resource.data.profId == request.auth.uid || isAdmin()
  );
}

match /entrees_cahier/{entreeId} {
  allow read: if isSignedIn();
  allow create: if isSignedIn()
    && request.resource.data.profId == request.auth.uid;
  allow update, delete: if isSignedIn() && (
    resource.data.profId == request.auth.uid || isAdmin()
  );
}

match /rappels_prof/{rappelId} {
  allow read, write: if request.auth != null
    && resource.data.profId == request.auth.uid;
  allow create: if request.auth != null
    && request.resource.data.profId == request.auth.uid;
}
        // ==================== PHASE 23 — SÉQUENCES PÉDAGOGIQUES ====================

    match /sequences_pedagogiques/{sequenceId} {
      allow read: if request.auth != null && (
        resource.data.profId == request.auth.uid || isAdmin()
      );
      allow create: if request.auth != null
        && request.resource.data.profId == request.auth.uid
        && getUserData().role == 'prof'
        && getUserData().isPremium == true;
      allow update, delete: if request.auth != null && (
        resource.data.profId == request.auth.uid || isAdmin()
      );
    }
	// ==================== COLLECTION: ebooks ====================
   match /ebooks/{ebookId} {
     allow read: if isSignedIn();
   allow create, update, delete: if isAdmin();
   }

      // ==================== COLLECTION: platform_settings ====================
   match /platform_settings/{docId} {
    allow read: if isAdmin();
    allow write: if isAdmin();
   }

      // ==================== COLLECTION: settings ====================
      // Utilisée par SettingsAdmin.tsx : doc(db, 'settings', 'platform')
   match /settings/{docId} {
    allow read: if isAdmin();
    allow write: if isAdmin();
   }
    // ==================== PHASE 24 — COURS EN LIGNE ====================

    // ─── Cours en ligne (Phase 24) ──────────────────────────────
    match /cours_en_ligne/{coursId} {
      allow read: if resource.data.statut == 'publie'
                  || (request.auth != null && resource.data.profId == request.auth.uid)
                  || request.auth.token.role == 'admin';

      allow create: if request.auth != null
        && request.resource.data.profId == request.auth.uid;

      allow update, delete: if request.auth != null && (
        resource.data.profId == request.auth.uid
        || request.auth.token.role == 'admin'
      );
    }

    // ─── Sections des cours (Phase 24) ──────────────────────────
    match /cours_sections/{sectionId} {
      allow read:  if true;
      allow write: if request.auth != null;
    }

    // ─── Progression élèves — Cours (Phase 24) ──────────────────
    match /progression_cours/{progressionId} {
      allow read, update: if request.auth != null
        && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
    }

    // ==================== COLLECTION: generated_content (Phase 16 — Générateur IA) ====================
    // Contenu généré par l'IA et sauvegardé par l'utilisateur.
    // Accessible uniquement par son auteur (userId) et les admins.
    // La création est réservée aux utilisateurs Premium, Profs et Admins.

    match /generated_content/{contentId} {
      allow read:   if isSignedIn() && (
                        resource.data.userId == request.auth.uid || isAdmin()
                      );
      allow create: if isSignedIn() &&
                        request.resource.data.userId == request.auth.uid &&
                        (isPremium() || isProf() || isAdmin());
      allow update: if isSignedIn() && (
                        resource.data.userId == request.auth.uid || isAdmin()
                      );
      allow delete: if isSignedIn() && (
                        resource.data.userId == request.auth.uid || isAdmin()
                      );
    }

    // ==================== COLLECTION: notifications ====================

    match /notifications/{notifId} {

      // Vérifie si l'utilisateur connecté est destinataire de la notification :
      //   - diffusion globale (destinataireRole == 'tous')
      //   - ciblage par rôle (prof, eleve, parent, admin...)
      //   - ciblage individuel (UID présent dans destinataireIds)
      function estDestinataire() {
        let data = resource.data;
        return data.destinataireId == request.auth.uid
            || data.destinataireRole == 'tous'
            || data.destinataireRole == getUserData().role
            || (data.destinataireIds != null && request.auth.uid in data.destinataireIds);
      }

      allow read:   if isSignedIn() && (estDestinataire() || isAdmin());
      allow create: if isProf() || isAdmin();
      allow update: if isAdmin()
                    || (isSignedIn() && resource.data.emetteurId == request.auth.uid)
                    || (isSignedIn() && estDestinataire());
      allow delete: if isAdmin();

      // ─── Sous-collection : lectures ──────────────────────────────
      // Stocke l'état "lu/non lu" par utilisateur.
      // Chaque document est identifié par l'UID du lecteur.
      match /lectures/{userId} {
        allow read:          if isOwner(userId) || isAdmin();
        allow create, update: if isOwner(userId);
        allow delete:        if isAdmin();
      }
    }

    // ==================== PAR DÉFAUT: DENY ALL ====================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

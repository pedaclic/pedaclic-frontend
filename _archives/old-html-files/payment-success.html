<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paiement R√©ussi - Pedaclic</title>
    
    <link rel="icon" type="image/svg+xml" href="assets/images/logo/logo-icon.svg">
    <link rel="stylesheet" href="assets/css/design-system.css">
    <link rel="stylesheet" href="assets/css/components/header.css">
    <link rel="stylesheet" href="assets/css/components/footer.css">
    
    <style>
        .success-container {
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-8) var(--space-4);
        }
        
        .success-card {
            max-width: 600px;
            width: 100%;
            background: var(--white);
            border-radius: var(--radius-3xl);
            padding: var(--space-12);
            text-align: center;
            box-shadow: var(--shadow-2xl);
            animation: scaleIn 0.5s ease;
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .success-icon {
            font-size: 120px;
            margin-bottom: var(--space-6);
            animation: bounce 1s ease;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .success-title {
            font-size: var(--text-4xl);
            font-weight: var(--font-extrabold);
            color: var(--accent-700);
            margin-bottom: var(--space-4);
        }
        
        .success-message {
            font-size: var(--text-xl);
            color: var(--gray-700);
            margin-bottom: var(--space-8);
            line-height: var(--leading-relaxed);
        }
        
        .success-details {
            background: var(--gray-50);
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-8);
            text-align: left;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: var(--font-semibold);
            color: var(--gray-600);
        }
        
        .detail-value {
            color: var(--gray-900);
            font-weight: var(--font-bold);
        }
        
        .success-actions {
            display: flex;
            gap: var(--space-4);
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .loader {
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary-600);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-4);
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header id="main-header"></header>
    
    <main class="success-container">
        <div class="success-card">
            <!-- Loader pendant v√©rification -->
            <div id="loadingState">
                <div class="loader"></div>
                <p style="color: var(--gray-600);">V√©rification du paiement...</p>
            </div>
            
            <!-- Contenu apr√®s v√©rification -->
            <div id="successContent" style="display: none;">
                <div class="success-icon">üéâ</div>
                
                <h1 class="success-title">Paiement R√©ussi !</h1>
                
                <p class="success-message">
                    F√©licitations ! Votre abonnement Premium a √©t√© activ√© avec succ√®s.
                    Vous pouvez maintenant profiter de tous les avantages Premium.
                </p>
                
                <div class="success-details">
                    <div class="detail-row">
                        <span class="detail-label">Plan</span>
                        <span class="detail-value" id="planName">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Montant</span>
                        <span class="detail-value" id="amount">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">R√©f√©rence</span>
                        <span class="detail-value" id="reference">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date</span>
                        <span class="detail-value" id="date">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Expire le</span>
                        <span class="detail-value" id="expiryDate">-</span>
                    </div>
                </div>
                
                <div class="success-actions">
                    <a href="index.html" class="btn-primary">
                        üè† Retour √† l'accueil
                    </a>
                    <a href="ressources.html" class="btn-secondary">
                        üìö Explorer les ressources
                    </a>
                </div>
            </div>
        </div>
    </main>
    
    <footer id="main-footer"></footer>
    
    <script src="assets/js/components/header.js"></script>
    <script src="assets/js/components/footer.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- PayTech Client -->
    <script src="assets/js/paytech-client.js"></script>
    
    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDgk_1graNBFkIURTJnyLZTZ1nyxi7slUo",
            authDomain: "pedaclic.firebaseapp.com",
            projectId: "pedaclic",
            storageBucket: "pedaclic.firebasestorage.app",
            messagingSenderId: "863649621890",
            appId: "1:863649621890:web:6ab56a8c8db111e3a9119b",
            measurementId: "G-20EGFVEM5M"
        };
        
        firebase.initializeApp(firebaseConfig);
        
        // V√©rifier le paiement
        async function verifyPayment() {
            try {
                // R√©cup√©rer la r√©f√©rence depuis l'URL
                const urlParams = new URLSearchParams(window.location.search);
                const ref = urlParams.get('ref');
                
                if (!ref) {
                    throw new Error('R√©f√©rence manquante');
                }
                
                // R√©cup√©rer depuis localStorage si pas dans URL
                const savedRef = localStorage.getItem('pedaclic_payment_ref');
                const transactionRef = ref || savedRef;
                
                if (!transactionRef) {
                    throw new Error('Impossible de retrouver la transaction');
                }
                
                // V√©rifier le statut
                const transaction = await paytechClient.checkPaymentStatus(transactionRef);
                
                if (transaction.status === 'completed') {
                    // Afficher les d√©tails
                    displaySuccessDetails(transaction);
                    
                    // Nettoyer localStorage
                    localStorage.removeItem('pedaclic_payment_ref');
                    
                } else if (transaction.status === 'pending') {
                    // Attendre encore un peu
                    setTimeout(verifyPayment, 2000);
                    
                } else {
                    throw new Error('Paiement non confirm√©');
                }
                
            } catch (error) {
                console.error('Erreur v√©rification:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="success-icon">‚ùå</div>
                    <h2 style="color: var(--gray-700);">Erreur de v√©rification</h2>
                    <p style="color: var(--gray-600);">${error.message}</p>
                    <button onclick="verifyPayment()" class="btn-primary" style="margin-top: 20px;">
                        R√©essayer
                    </button>
                `;
            }
        }
        
        // Afficher les d√©tails
        function displaySuccessDetails(transaction) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('successContent').style.display = 'block';
            
            // Plans
            const planNames = {
                monthly: 'Premium Mensuel',
                annual: 'Premium Annuel'
            };
            
            const planAmounts = {
                monthly: '2,000 FCFA',
                annual: '20,000 FCFA'
            };
            
            // Remplir les d√©tails
            document.getElementById('planName').textContent = planNames[transaction.plan] || transaction.plan;
            document.getElementById('amount').textContent = planAmounts[transaction.plan] || transaction.amount + ' FCFA';
            document.getElementById('reference').textContent = transaction.ref;
            
            const date = new Date(transaction.createdAt._seconds * 1000);
            document.getElementById('date').textContent = date.toLocaleDateString('fr-FR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Calculer date d'expiration
            const expiryDays = transaction.plan === 'monthly' ? 30 : 365;
            const expiryDate = new Date(date.getTime() + (expiryDays * 24 * 60 * 60 * 1000));
            document.getElementById('expiryDate').textContent = expiryDate.toLocaleDateString('fr-FR', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }
        
        // Lancer la v√©rification au chargement
        window.addEventListener('DOMContentLoaded', verifyPayment);
    </script>
</body>
</html>
